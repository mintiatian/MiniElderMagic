<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ğŸ§™ã‚’WASDã§å‹•ã‹ã™ - ã‚¹ãƒ ãƒ¼ã‚ºç§»å‹•</title>
  <style>
    /* ç”»é¢å…¨ä½“ã‚’è¡¨ç¤ºé ˜åŸŸã« */
    #game-area {
      width: 100vw;
      height: 100vh;
      position: relative;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #333; /* HUDæ–‡å­—è‰²ãŒè¦‹ã‚„ã™ã„ã‚ˆã†ã«èƒŒæ™¯ã‚’è¿½åŠ (ä»»æ„) */
    }
    /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .character {
      position: absolute;
      font-size: 50px;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
  </style>
</head>
<body>
<div id="game-area"></div>

<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
<script type="module">
  import { PlayerBase } from './Script/playerBase.js';
  import { EnemyBase } from './Script/enemyBase.js';
  import { UIHud } from './Script/UIHud.js';  // UIHud ã‚’è¿½åŠ 
  import { Coin } from './Script/coin_character.js';  // coin_character.jsã‹ã‚‰Coinã‚’è¿½åŠ 
  import { Stair } from './Script/Stair.js';  // æ–°ã—ãè¿½åŠ ã—ãŸéšæ®µã‚¯ãƒ©ã‚¹

  const gameArea = document.getElementById('game-area');

  // æŠ¼ä¸‹çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  const pressedKeys = {};

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆ
  const wizard = new PlayerBase(100, 100, 3, 'ğŸ§™', gameArea);
  wizard.draw();

  // æ•µã‚’ç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•ã®ä¾‹ï¼‰
  const enemy = new EnemyBase(300, 300, 2, 'ğŸ‘¾', gameArea);
  enemy.draw();

  // HUDã®ç”Ÿæˆ
  const hud = new UIHud(gameArea);

  // ã‚³ã‚¤ãƒ³ã®é…åˆ—ã‚’ç®¡ç†
  let coins = [];

  // ãƒ‡ãƒ¢ç”¨ã«åˆæœŸã‚³ã‚¤ãƒ³ã‚’ç”Ÿæˆ
  const initialCoin = new Coin(200, 200, gameArea);
  initialCoin.draw();
  coins.push(initialCoin);

  // éšæ®µã‚’ç”Ÿæˆ
  const stair = new Stair(500, 400, gameArea);
  stair.draw();

  // ã‚­ãƒ¼ã®æŠ¼ä¸‹çŠ¶æ…‹ã‚’ç›£è¦–
  document.addEventListener('keydown', (event) => {
    pressedKeys[event.key.toLowerCase()] = true;
  });
  document.addEventListener('keyup', (event) => {
    pressedKeys[event.key.toLowerCase()] = false;
  });

  // 1å›ã‚ãŸã‚Šã®ç†æƒ³ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  const FPS = 60;
  const FRAME_TIME = 1000 / FPS; // 1000ms Ã· 60fps â‰ˆ 16.6667ms

  let lastTime = performance.now();
  let accumulatedTime = 0; // çµŒéæ™‚é–“ã‚’ãŸã‚ã‚‹ãŸã‚ã®å¤‰æ•°

  // ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®ãƒ«ãƒ¼ãƒ—
  function gameLoop(timestamp) {
    const delta = timestamp - lastTime;
    lastTime = timestamp;
    accumulatedTime += delta;

    while (accumulatedTime >= FRAME_TIME) {
      updateGame();
      accumulatedTime -= FRAME_TIME;
    }
    requestAnimationFrame(gameLoop);
  }

  // ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢å†…ã®ã™ã¹ã¦ã®Coinã‚’æ¢ã™
  function findAllCoins() {
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸã‚³ã‚¤ãƒ³ã‚’å…¨ã¦å–å¾—
    const coinElements = document.querySelectorAll('.character');
    coins = [];
    
    coinElements.forEach(element => {
      // çµµæ–‡å­—ãŒğŸª™ã®ã‚‚ã®ã ã‘ãŒã‚³ã‚¤ãƒ³
      if (element.textContent === 'ğŸª™') {
        // å¯¾å¿œã™ã‚‹Coinã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™å‡¦ç†
        // ç°¡æ˜“å®Ÿè£…: è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ã‚¤ãƒ³ã¯æ•µãŒå€’ã•ã‚ŒãŸæ™‚ã«ä½œã‚‰ã‚Œã‚‹ã®ã§æ¤œå‡ºä¸è¦
      }
    });
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¸ãŒå¤‰ã‚ã£ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
  function onStageChange() {
    // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    enemy.status.hp = enemy.status.maxHP; // æ•µã®HPã‚’å›å¾©
    
    // éšæ®µã®ä½ç½®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰æ›´
    const maxX = gameArea.clientWidth - 100;
    const maxY = gameArea.clientHeight - 100;
    const newX = Math.random() * maxX + 50;
    const newY = Math.random() * maxY + 50;
    stair.x = newX;
    stair.y = newY;
    stair.draw();
    
    // éšæ®µã®ã‚¿ãƒƒãƒãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    stair.touched = false;
    
    // æ•µã®ä½ç½®ã‚‚ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰æ›´
    enemy.x = Math.random() * maxX + 50;
    enemy.y = Math.random() * maxY + 50;
    
    // ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    const stageElement = document.createElement('div');
    stageElement.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸ ${wizard.playerstatus.stage}`;
    stageElement.style.position = 'absolute';
    stageElement.style.top = '50%';
    stageElement.style.left = '50%';
    stageElement.style.transform = 'translate(-50%, -50%)';
    stageElement.style.fontSize = '48px';
    stageElement.style.fontWeight = 'bold';
    stageElement.style.color = 'white';
    stageElement.style.textShadow = '3px 3px 5px rgba(0, 0, 0, 0.8)';
    stageElement.style.zIndex = '1000';
    stageElement.style.opacity = '0';
    stageElement.style.transition = 'opacity 0.5s ease-in, transform 0.5s ease-in';
    
    gameArea.appendChild(stageElement);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    setTimeout(() => {
      stageElement.style.opacity = '1';
      stageElement.style.transform = 'translate(-50%, -50%) scale(1.2)';
      
      setTimeout(() => {
        stageElement.style.opacity = '0';
        stageElement.style.transform = 'translate(-50%, -50%) scale(0.8)';
        
        setTimeout(() => {
          if (stageElement.parentNode) {
            stageElement.parentNode.removeChild(stageElement);
          }
        }, 500);
      }, 1500);
    }, 10);
  }

  function updateGame() {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›çŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆ & æ›´æ–°
    wizard.setKeyState(pressedKeys);
    wizard.update();

    // æ•µã®æ›´æ–°ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•ï¼‰
    enemy.update();
    
    // éšæ®µã®æ›´æ–°ã¨æ¥è§¦åˆ¤å®š
    stair.update();
    if (stair.checkCollision(wizard)) {
      if (stair.onTouch(wizard)) {
        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’1ä¸Šã’ã‚‹
        wizard.playerstatus.nextStage();
        
        // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        onStageChange();
      }
    }

    // æ•µãŒå€’ã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«ã‚³ã‚¤ãƒ³ãŒç”Ÿæˆã•ã‚Œã‚‹
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã®ã‚³ã‚¤ãƒ³ã‚’å–å¾—
    const coinElements = document.querySelectorAll('.character');
    coinElements.forEach(element => {
      if (element.textContent === 'ğŸª™') {
        // å„ã‚³ã‚¤ãƒ³ã«å¯¾ã™ã‚‹å‚ç…§ã‚’æŒã¤å¿…è¦ãŒã‚ã‚‹ãŒã€
        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ä½ç½®ã‹ã‚‰åˆ¤å®š
        const rect = element.getBoundingClientRect();
        const coinX = rect.left + rect.width / 2;
        const coinY = rect.top + rect.height / 2;
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®
        const playerRect = wizard.element.getBoundingClientRect();
        const playerX = playerRect.left + playerRect.width / 2;
        const playerY = playerRect.top + playerRect.height / 2;
        
        // è·é›¢ã‚’è¨ˆç®—
        const dx = coinX - playerX;
        const dy = coinY - playerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // 30pxä»¥å†…ã«è¿‘ã¥ã„ãŸã‚‰ã‚³ã‚¤ãƒ³ã‚’å–å¾—
        if (distance < 40) {
          // ã‚³ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          element.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
          element.style.transform = 'scale(1.5)';
          element.style.opacity = '0';
          
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚³ã‚¤ãƒ³ã‚’å¢—ã‚„ã™
          wizard.playerstatus.addCoins(1);
          
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«è¦ç´ ã‚’å‰Šé™¤
          setTimeout(() => {
            if (element && element.parentNode) {
              element.parentNode.removeChild(element);
            }
          }, 300);
        }
      }
    });

    // HUDã‚’æ›´æ–°ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¸¡ã™ï¼‰
    hud.update(wizard.playerstatus);

    // è¡çªåˆ¤å®šã—ãŸã„ç›¸æ‰‹ã‚’é…åˆ—ã«ã¾ã¨ã‚ã‚‹ï¼ˆæ•µãŒè¤‡æ•°ãªã‚‰é…åˆ—ã« pushï¼‰
    const targets = [enemy];

    // wizard.attacks ã®å¼¾ãã‚Œãã‚Œã«å¯¾ã—ã€targets ã‚’æ¸¡ã—ã¦è¡çªåˆ¤å®š
    wizard.attacks.forEach((fireBall) => {
      fireBall.update(targets);
    });
  }

  // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹
  requestAnimationFrame(gameLoop);
</script>
</body>
</html>