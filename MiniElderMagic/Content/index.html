<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ğŸ§™ã‚’WASDã§å‹•ã‹ã™ - ã‚¹ãƒ ãƒ¼ã‚ºç§»å‹•</title>
  <style>
    /* ç”»é¢å…¨ä½“ã‚’è¡¨ç¤ºé ˜åŸŸã« */
    #game-area {
      width: 100vw;
      height: 100vh;
      position: relative;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #333; /* HUDæ–‡å­—è‰²ãŒè¦‹ã‚„ã™ã„ã‚ˆã†ã«èƒŒæ™¯ã‚’è¿½åŠ (ä»»æ„) */
    }
    /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .character {
      position: absolute;
      font-size: 50px;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* ä¸­å¿ƒä½ç½®ã‚’åŸºæº–ã«ã™ã‚‹å ´åˆã¯ã€å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§å€‹åˆ¥ã«è¨­å®š */
      /* transform: translate(-50%, -50%); */
      text-align: center;
    }
  </style>
</head>
<body>
<div id="game-area"></div>

<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
<script type="module">
  import { PlayerBase } from './Script/playerBase.js';
  import { UIHud } from './Script/UIHud.js';
  import { Coin } from './Script/coin_character.js';
  import { Stair } from './Script/Stair.js';
  import { Stage } from './Script/Stage.js';  // æ–°ã—ãè¿½åŠ ã—ãŸã‚¹ãƒ†ãƒ¼ã‚¸ç®¡ç†ã‚¯ãƒ©ã‚¹

  const gameArea = document.getElementById('game-area');

  // æŠ¼ä¸‹çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  const pressedKeys = {};

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆ
  const wizard = new PlayerBase(100, 100, 3, 'ğŸ§™', gameArea);
  wizard.draw();

  // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ç”Ÿæˆ
  const stageManager = new Stage(gameArea);

  // æœ€åˆã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®æ•µã‚’ç”Ÿæˆ
  const enemies = stageManager.createEnemiesForStage(1);

  // HUDã®ç”Ÿæˆ
  const hud = new UIHud(gameArea);

  // ã‚³ã‚¤ãƒ³ã®é…åˆ—ã‚’ç®¡ç†
  let coins = [];

  // ãƒ‡ãƒ¢ç”¨ã«åˆæœŸã‚³ã‚¤ãƒ³ã‚’ç”Ÿæˆ
  const initialCoin = new Coin(200, 200, gameArea);
  initialCoin.draw();
  coins.push(initialCoin);

  // éšæ®µã‚’ç”Ÿæˆ
  const stair = new Stair(500, 400, gameArea);
  stair.draw();

  // ã‚­ãƒ¼ã®æŠ¼ä¸‹çŠ¶æ…‹ã‚’ç›£è¦–
  document.addEventListener('keydown', (event) => {
    const key = event.key.toLowerCase();
    pressedKeys[key] = true;
    
    // æ–¹å‘ã‚­ãƒ¼ã‚‚WASDã«ãƒãƒƒãƒ”ãƒ³ã‚°
    if (key === 'arrowup') pressedKeys['w'] = true;
    if (key === 'arrowdown') pressedKeys['s'] = true;
    if (key === 'arrowleft') pressedKeys['a'] = true;
    if (key === 'arrowright') pressedKeys['d'] = true;
  });
  
  document.addEventListener('keyup', (event) => {
    const key = event.key.toLowerCase();
    pressedKeys[key] = false;
    
    // æ–¹å‘ã‚­ãƒ¼ã‚‚WASDã«ãƒãƒƒãƒ”ãƒ³ã‚°è§£é™¤
    if (key === 'arrowup') pressedKeys['w'] = false;
    if (key === 'arrowdown') pressedKeys['s'] = false;
    if (key === 'arrowleft') pressedKeys['a'] = false;
    if (key === 'arrowright') pressedKeys['d'] = false;
  });

  // æ•µãŒæ­»ã‚“ã ã¨ãã«ã‚³ã‚¤ãƒ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
  function createCoinAt(x, y) {
    const coin = new Coin(x, y, gameArea);
    coin.draw();
    coins.push(coin);
  }

  // 1å›ã‚ãŸã‚Šã®ç†æƒ³ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  const FPS = 60;
  const FRAME_TIME = 1000 / FPS; // 1000ms Ã· 60fps â‰ˆ 16.6667ms

  let lastTime = performance.now();
  let accumulatedTime = 0; // çµŒéæ™‚é–“ã‚’ãŸã‚ã‚‹ãŸã‚ã®å¤‰æ•°

  // ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®ãƒ«ãƒ¼ãƒ—
  function gameLoop(timestamp) {
    const delta = timestamp - lastTime;
    lastTime = timestamp;
    accumulatedTime += delta;

    while (accumulatedTime >= FRAME_TIME) {
      updateGame();
      accumulatedTime -= FRAME_TIME;
    }
    requestAnimationFrame(gameLoop);
  }

  // ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢å†…ã®ã™ã¹ã¦ã®Coinã‚’æ¢ã™
  function findAllCoins() {
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸã‚³ã‚¤ãƒ³ã‚’å…¨ã¦å–å¾—
    const coinElements = document.querySelectorAll('.character');
    coins = [];
    
    coinElements.forEach(element => {
      // çµµæ–‡å­—ãŒğŸª™ã®ã‚‚ã®ã ã‘ãŒã‚³ã‚¤ãƒ³
      if (element.textContent === 'ğŸª™') {
        // å¯¾å¿œã™ã‚‹Coinã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™å‡¦ç†
        // ç°¡æ˜“å®Ÿè£…: è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ã‚¤ãƒ³ã¯æ•µãŒå€’ã•ã‚ŒãŸæ™‚ã«ä½œã‚‰ã‚Œã‚‹ã®ã§æ¤œå‡ºä¸è¦
      }
    });
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¸ãŒå¤‰ã‚ã£ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
  function onStageChange() {
    // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
    const currentStage = wizard.playerstatus.stage;
    const enemies = stageManager.createEnemiesForStage(currentStage);
    
    // éšæ®µã®ä½ç½®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰æ›´
    const maxX = gameArea.clientWidth - 100;
    const maxY = gameArea.clientHeight - 100;
    const newX = Math.random() * maxX + 50;
    const newY = Math.random() * maxY + 50;
    stair.x = newX;
    stair.y = newY;
    stair.draw();
    
    // éšæ®µã®ã‚¿ãƒƒãƒãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    stair.touched = false;
    
    // ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    const stageElement = document.createElement('div');
    stageElement.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸ ${currentStage}`;
    stageElement.style.position = 'absolute';
    stageElement.style.top = '50%';
    stageElement.style.left = '50%';
    stageElement.style.transform = 'translate(-50%, -50%)';
    stageElement.style.fontSize = '48px';
    stageElement.style.fontWeight = 'bold';
    stageElement.style.color = 'white';
    stageElement.style.textShadow = '3px 3px 5px rgba(0, 0, 0, 0.8)';
    stageElement.style.zIndex = '1000';
    stageElement.style.opacity = '0';
    stageElement.style.transition = 'opacity 0.5s ease-in, transform 0.5s ease-in';
    
    gameArea.appendChild(stageElement);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    setTimeout(() => {
      stageElement.style.opacity = '1';
      stageElement.style.transform = 'translate(-50%, -50%) scale(1.2)';
      
      setTimeout(() => {
        stageElement.style.opacity = '0';
        stageElement.style.transform = 'translate(-50%, -50%) scale(0.8)';
        
        setTimeout(() => {
          if (stageElement.parentNode) {
            stageElement.parentNode.removeChild(stageElement);
          }
        }, 500);
      }, 1500);
    }, 10);
  }

  // å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ç”Ÿãã¦ã„ãŸæ•µã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®é…åˆ—
  let previousLivingEnemies = [...stageManager.enemies];

  function updateGame() {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›çŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆ & æ›´æ–°
    wizard.setKeyState(pressedKeys);
    wizard.update();

    // å„æ•µã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‚ç…§ã‚’è¨­å®šã—ã€æ›´æ–°
    stageManager.enemies.forEach(enemy => {
      if (!enemy.playerTarget) {
        enemy.setPlayerTarget(wizard);
      }
    });
    
    // æ•µã®æ›´æ–°
    stageManager.updateEnemies();
    
    // å„æ•µã«ã¤ã„ã¦ã€å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã«ã¯ç”Ÿãã¦ã„ãŸãŒä»Šã¯é…åˆ—ã«ãªã„æ•µã«ã‚³ã‚¤ãƒ³ã‚’ç”Ÿæˆ
    const currentEnemies = stageManager.enemies;
    previousLivingEnemies.forEach(prevEnemy => {
      // ç¾åœ¨ã®æ•µã®é…åˆ—ã«å«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã€ãã®æ•µã¯å€’ã•ã‚ŒãŸã¨ã„ã†ã“ã¨
      if (!currentEnemies.includes(prevEnemy)) {
        // ã‚³ã‚¤ãƒ³ã‚’æ•µã®ä½ç½®ã«ç”Ÿæˆ
        const pos = stageManager.getEnemyPosition(prevEnemy);
        if (pos) {
          createCoinAt(pos.x, pos.y);
        }
      }
    });
    
    // ç¾åœ¨ã®æ•µãƒªã‚¹ãƒˆã‚’æ›´æ–°
    previousLivingEnemies = [...currentEnemies];
    
    // å…¨ã¦ã®æ•µãŒå€’ã•ã‚Œã¦ã„ã¦ã€éšæ®µãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯éšæ®µã‚’è¡¨ç¤º
    if (stageManager.areAllEnemiesDefeated() && !stair.element.style.visibility) {
      stair.element.style.visibility = 'visible';
    }
    
    // éšæ®µã®æ›´æ–°ã¨æ¥è§¦åˆ¤å®š
    stair.update();
    if (stair.checkCollision(wizard)) {
      if (stair.onTouch(wizard)) {
        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’1ä¸Šã’ã‚‹
        wizard.playerstatus.nextStage();
        
        // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        onStageChange();
      }
    }

    // ã‚³ã‚¤ãƒ³ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¥è§¦åˆ¤å®š
    const coinElements = document.querySelectorAll('.character');
    coinElements.forEach(element => {
      if (element.textContent === 'ğŸª™') {
        // å„ã‚³ã‚¤ãƒ³ã«å¯¾ã™ã‚‹å‚ç…§ã‚’æŒã¤å¿…è¦ãŒã‚ã‚‹ãŒã€
        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ä½ç½®ã‹ã‚‰åˆ¤å®š
        const rect = element.getBoundingClientRect();
        const coinX = rect.left + rect.width / 2;
        const coinY = rect.top + rect.height / 2;
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®
        const playerRect = wizard.element.getBoundingClientRect();
        const playerX = playerRect.left + playerRect.width / 2;
        const playerY = playerRect.top + playerRect.height / 2;
        
        // è·é›¢ã‚’è¨ˆç®—
        const dx = coinX - playerX;
        const dy = coinY - playerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // 40pxä»¥å†…ã«è¿‘ã¥ã„ãŸã‚‰ã‚³ã‚¤ãƒ³ã‚’å–å¾—
        if (distance < 40) {
          // ã‚³ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          element.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
          element.style.transform = 'scale(1.5)';
          element.style.opacity = '0';
          
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚³ã‚¤ãƒ³ã‚’å¢—ã‚„ã™
          wizard.playerstatus.addCoins(1);
          
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«è¦ç´ ã‚’å‰Šé™¤
          setTimeout(() => {
            if (element && element.parentNode) {
              element.parentNode.removeChild(element);
            }
          }, 300);
        }
      }
    });

    // HUDã‚’æ›´æ–°ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¸¡ã™ï¼‰
    hud.update(wizard.playerstatus);

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒã¨æ•µã®è¡çªåˆ¤å®š
    const enemyTargets = stageManager.enemies;
    wizard.attacks.forEach((fireBall) => {
      fireBall.update(enemyTargets);
    });
    
    // æ•µã®æ”»æ’ƒã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡çªåˆ¤å®šï¼ˆæ•µã®å†…éƒ¨ã§å‡¦ç†ï¼‰
    // ã™ã§ã«å„æ•µã®updateãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€enemyTargetï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã‚’å¯¾è±¡ã¨ã—ãŸè¡çªåˆ¤å®šãŒè¡Œã‚ã‚Œã¦ã„ã‚‹
    
    // HPãŒ0ã«ãªã£ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
    if (wizard.status.hp <= 0) {
      // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ã‚’è¿½åŠ 
      displayGameOver();
    }
  }

  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤ºé–¢æ•°
  function displayGameOver() {
    // ã™ã§ã«ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ãŒã‚ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (document.getElementById('game-over')) return;
    
    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¦ç´ ã‚’ä½œæˆ
    const gameOverElement = document.createElement('div');
    gameOverElement.id = 'game-over';
    gameOverElement.style.position = 'absolute';
    gameOverElement.style.top = '50%';
    gameOverElement.style.left = '50%';
    gameOverElement.style.transform = 'translate(-50%, -50%)';
    gameOverElement.style.fontSize = '60px';
    gameOverElement.style.fontWeight = 'bold';
    gameOverElement.style.color = 'red';
    gameOverElement.style.textShadow = '3px 3px 5px rgba(0, 0, 0, 0.8)';
    gameOverElement.style.zIndex = '1000';
    gameOverElement.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    gameOverElement.style.padding = '30px';
    gameOverElement.style.borderRadius = '15px';
    gameOverElement.style.textAlign = 'center';
    gameOverElement.innerHTML = `
      <div>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</div>
      <div style="font-size: 30px; margin-top: 20px;">ã‚¹ãƒ†ãƒ¼ã‚¸: ${wizard.playerstatus.stage}</div>
      <div style="font-size: 30px;">ã‚³ã‚¤ãƒ³: ${wizard.playerstatus.coins}</div>
      <div style="font-size: 24px; margin-top: 40px;">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ã«ã¯F5ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    `;
    
    gameArea.appendChild(gameOverElement);
    
    // ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹åŠ¹æœï¼ˆã™ã¹ã¦ã®æ•µã‚’æ­¢ã‚ã‚‹ï¼‰
    stageManager.clearEnemies();
  }
  
  // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹
  requestAnimationFrame(gameLoop);
</script>
</body>
</html>