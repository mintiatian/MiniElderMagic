<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ğŸ§™ã‚’WASDã§å‹•ã‹ã™ - ã‚¹ãƒ ãƒ¼ã‚ºç§»å‹•</title>
  <style>
    /* ç”»é¢å…¨ä½“ã‚’è¡¨ç¤ºé ˜åŸŸã« */
    #game-area {
      width: 100vw;
      height: 100vh;
      position: relative;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #333; /* HUDæ–‡å­—è‰²ãŒè¦‹ã‚„ã™ã„ã‚ˆã†ã«èƒŒæ™¯ã‚’è¿½åŠ (ä»»æ„) */
    }
    /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .character {
      position: absolute;
      font-size: 50px;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* ä¸­å¿ƒä½ç½®ã‚’åŸºæº–ã«ã™ã‚‹å ´åˆã¯ã€å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§å€‹åˆ¥ã«è¨­å®š */
      /* transform: translate(-50%, -50%); */
      text-align: center;
    }
  </style>
</head>
<body>
<div id="game-area"></div>

<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
<script type="module">
  import { PlayerBase } from './Script/playerBase.js';
  import { UIHud } from './Script/UIHud.js';
  import { Coin } from './Script/coin_character.js';
  import { Stair } from './Script/Stair.js';
  import { Stage } from './Script/Stage.js';  // æ–°ã—ãè¿½åŠ ã—ãŸã‚¹ãƒ†ãƒ¼ã‚¸ç®¡ç†ã‚¯ãƒ©ã‚¹
  import { UIShop } from './Script/UIShop.js'; // ã‚·ãƒ§ãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  import { UIStatus } from './Script/UIStatus.js'; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  import { UIDebug } from './Script/UIDebug.js'; // ãƒ‡ãƒãƒƒã‚°ç”»é¢ã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

  const gameArea = document.getElementById('game-area');

  // æŠ¼ä¸‹çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  const pressedKeys = {};

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆ
  const wizard = new PlayerBase(100, 100, 3, 'ğŸ§™', gameArea);
  wizard.draw();

  // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ç”Ÿæˆ
  const stageManager = new Stage(gameArea);

  // æœ€åˆã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®æ•µã‚’ç”Ÿæˆ
  const enemies = stageManager.createEnemiesForStage(1);

  // HUDã®ç”Ÿæˆ
  const hud = new UIHud(gameArea);
  
  // ã‚·ãƒ§ãƒƒãƒ—ã®ç”Ÿæˆ
  const shop = new UIShop(gameArea, wizard);
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã®ç”Ÿæˆ
  const statusUI = new UIStatus(gameArea, wizard);

  // ãƒ‡ãƒãƒƒã‚°ç”»é¢ã®ç”Ÿæˆ
  const debugUI = new UIDebug(gameArea, wizard);
  
  // ã‚³ã‚¤ãƒ³ã®é…åˆ—ã‚’ç®¡ç†
  let coins = [];

  // ãƒ‡ãƒ¢ç”¨ã«åˆæœŸã‚³ã‚¤ãƒ³ã‚’ç”Ÿæˆ
  const initialCoin = new Coin(200, 200, gameArea);
  initialCoin.draw();
  coins.push(initialCoin);

  // éšæ®µã‚’ç”Ÿæˆ
  const stair = new Stair(500, 400, gameArea);
  stair.draw();

  // ã‚·ãƒ§ãƒƒãƒ—å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼ï¼ˆä¸€åº¦ã ã‘ç™»éŒ²ï¼‰
  document.addEventListener('shopCompleted', () => {
    // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’1ä¸Šã’ã‚‹
    wizard.playerstatus.nextStage();
    
    // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    onStageChange();
  });
  
  // ã‚­ãƒ¼ã®æŠ¼ä¸‹çŠ¶æ…‹ã‚’ç›£è¦–
  document.addEventListener('keydown', (event) => {
    const key = event.key.toLowerCase();
    
    // Tabã‚­ãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ–ãƒ©ã‚¦ã‚¶ã®å‹•ä½œã‚’é˜²æ­¢ã™ã‚‹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢UIã§å‡¦ç†ã™ã‚‹ãŸã‚ï¼‰
    if (key === 'tab') {
      event.preventDefault();
    } 
    // 'o'ã‚­ãƒ¼ã§ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
    else if (key === 'o') {
      debugUI.toggle();
      // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      const message = debugUI.isVisible ? 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ON' : 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: OFF';
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.position = 'absolute';
      notification.style.top = '10px';
      notification.style.left = '50%';
      notification.style.transform = 'translateX(-50%)';
      notification.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      notification.style.color = debugUI.isVisible ? '#0f0' : '#fff';
      notification.style.padding = '8px 15px';
      notification.style.borderRadius = '5px';
      notification.style.fontSize = '16px';
      notification.style.zIndex = '9999';
      gameArea.appendChild(notification);
      
      // 2ç§’å¾Œã«é€šçŸ¥ã‚’æ¶ˆã™
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s ease';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 500);
        }
      }, 2000);
    }
    else {
      pressedKeys[key] = true;
      
      // æ–¹å‘ã‚­ãƒ¼ã‚‚WASDã«ãƒãƒƒãƒ”ãƒ³ã‚°
      if (key === 'arrowup') pressedKeys['w'] = true;
      if (key === 'arrowdown') pressedKeys['s'] = true;
      if (key === 'arrowleft') pressedKeys['a'] = true;
      if (key === 'arrowright') pressedKeys['d'] = true;
    }
  });
  
  document.addEventListener('keyup', (event) => {
    const key = event.key.toLowerCase();
    pressedKeys[key] = false;
    
    // æ–¹å‘ã‚­ãƒ¼ã‚‚WASDã«ãƒãƒƒãƒ”ãƒ³ã‚°è§£é™¤
    if (key === 'arrowup') pressedKeys['w'] = false;
    if (key === 'arrowdown') pressedKeys['s'] = false;
    if (key === 'arrowleft') pressedKeys['a'] = false;
    if (key === 'arrowright') pressedKeys['d'] = false;
  });

  // æ•µãŒæ­»ã‚“ã ã¨ãã«ã‚³ã‚¤ãƒ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
  function createCoinAt(x, y) {
    const coin = new Coin(x, y, gameArea);
    coin.draw();
    coins.push(coin);
  }

  // 1å›ã‚ãŸã‚Šã®ç†æƒ³ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  const FPS = 60;
  const FRAME_TIME = 1000 / FPS; // 1000ms Ã· 60fps â‰ˆ 16.6667ms

  let lastTime = performance.now();
  let accumulatedTime = 0; // çµŒéæ™‚é–“ã‚’ãŸã‚ã‚‹ãŸã‚ã®å¤‰æ•°

  // ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®ãƒ«ãƒ¼ãƒ—
  function gameLoop(timestamp) {
    const delta = timestamp - lastTime;
    lastTime = timestamp;
    accumulatedTime += delta;

    while (accumulatedTime >= FRAME_TIME) {
      updateGame();
      accumulatedTime -= FRAME_TIME;
    }
    requestAnimationFrame(gameLoop);

  }

  // ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢å†…ã®ã™ã¹ã¦ã®Coinã‚’æ¢ã™
  function findAllCoins() {
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸã‚³ã‚¤ãƒ³ã‚’å…¨ã¦å–å¾—
    const coinElements = document.querySelectorAll('.character');
    coins = [];
    
    coinElements.forEach(element => {
      // çµµæ–‡å­—ãŒğŸª™ã®ã‚‚ã®ã ã‘ãŒã‚³ã‚¤ãƒ³
      if (element.textContent === 'ğŸª™') {
        // å¯¾å¿œã™ã‚‹Coinã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™å‡¦ç†
        // ç°¡æ˜“å®Ÿè£…: è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ã‚¤ãƒ³ã¯æ•µãŒå€’ã•ã‚ŒãŸæ™‚ã«ä½œã‚‰ã‚Œã‚‹ã®ã§æ¤œå‡ºä¸è¦
      }
    });
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¸ãŒå¤‰ã‚ã£ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
  function onStageChange() {
    // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
    const currentStage = wizard.playerstatus.stage;
    const enemies = stageManager.createEnemiesForStage(currentStage);
    
    // éšæ®µã®ä½ç½®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰æ›´
    const maxX = gameArea.clientWidth - 100;
    const maxY = gameArea.clientHeight - 100;
    const newX = Math.random() * maxX + 50;
    const newY = Math.random() * maxY + 50;
    stair.x = newX;
    stair.y = newY;
    stair.draw();
    
    // éšæ®µã®ã‚¿ãƒƒãƒãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    stair.touched = false;
    
    // ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    const stageElement = document.createElement('div');
    stageElement.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸ ${currentStage}`;
    stageElement.style.position = 'absolute';
    stageElement.style.top = '50%';
    stageElement.style.left = '50%';
    stageElement.style.transform = 'translate(-50%, -50%)';
    stageElement.style.fontSize = '48px';
    stageElement.style.fontWeight = 'bold';
    stageElement.style.color = 'white';
    stageElement.style.textShadow = '3px 3px 5px rgba(0, 0, 0, 0.8)';
    stageElement.style.zIndex = '1000';
    stageElement.style.opacity = '0';
    stageElement.style.transition = 'opacity 0.5s ease-in, transform 0.5s ease-in';
    
    gameArea.appendChild(stageElement);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    setTimeout(() => {
      stageElement.style.opacity = '1';
      stageElement.style.transform = 'translate(-50%, -50%) scale(1.2)';
      
      setTimeout(() => {
        stageElement.style.opacity = '0';
        stageElement.style.transform = 'translate(-50%, -50%) scale(0.8)';
        
        setTimeout(() => {
          if (stageElement.parentNode) {
            stageElement.parentNode.removeChild(stageElement);
          }
        }, 500);
      }, 1500);
    }, 10);
  }

  // å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ç”Ÿãã¦ã„ãŸæ•µã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®é…åˆ—
  let previousLivingEnemies = [...stageManager.enemies];
  // æ•µã®è¦ç´ ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®Mapï¼ˆè¦ç´ ID -> è¦ç´ ï¼‰
  const enemyElementMap = new Map();
  
  function updateGame() {
    
    // ã‚·ãƒ§ãƒƒãƒ—è¡¨ç¤ºä¸­ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•ï¼æ”»æ’ƒã‚’ç„¡åŠ¹åŒ–
    if (!shop.isVisible && !shop.isCountingDown) {
      // æ™®é€šã«å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã¦æ›´æ–°
      wizard.setKeyState(pressedKeys);
      wizard.update();
    }
  
    // å„æ•µã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‚ç…§ã‚’è¨­å®šã—ã€æ›´æ–°
    stageManager.enemies.forEach(enemy => {
      if (!enemy.playerTarget) {
        enemy.setPlayerTarget(wizard);
      }
      
      // æ•µè¦ç´ ã‚’ãƒãƒƒãƒ—ã«è¿½åŠ ï¼ˆè¿½è·¡ç”¨ï¼‰
      if (enemy.element && !enemyElementMap.has(enemy.element.id)) {
        // è¦ç´ ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’è¨­å®šï¼ˆã¾ã ãªã„å ´åˆï¼‰
        if (!enemy.element.id) {
          enemy.element.id = `enemy-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        }
        enemyElementMap.set(enemy.element.id, enemy);
      }
    });
    
    // æ•µã®æ›´æ–°å‰ã«ç¾åœ¨ã®æ•µãƒªã‚¹ãƒˆã‚’ä¿å­˜
    const beforeUpdateEnemies = [...stageManager.enemies];
    
    // æ•µã®æ›´æ–°ï¼ˆã“ã“ã§æ­»äº¡ã—ãŸæ•µã¯é…åˆ—ã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹ï¼‰
    stageManager.updateEnemies();
    
    // å„æ•µã«ã¤ã„ã¦ã€å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã«ã¯ç”Ÿãã¦ã„ãŸãŒä»Šã¯é…åˆ—ã«ãªã„æ•µã«ã‚³ã‚¤ãƒ³ã‚’ç”Ÿæˆ
    const currentEnemies = stageManager.enemies;
    
    // å‰å›ã‹ã‚‰æ¶ˆãˆãŸæ•µã‚’ç‰¹å®š
    beforeUpdateEnemies.forEach(prevEnemy => {
      // ç¾åœ¨ã®æ•µã®é…åˆ—ã«å«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã€ãã®æ•µã¯å€’ã•ã‚ŒãŸã¨ã„ã†ã“ã¨
      if (!currentEnemies.includes(prevEnemy) && prevEnemy.status.hp <= 0) {
        console.log(`[Game] æ•µãŒå€’ã•ã‚ŒãŸ: ${prevEnemy.emoji}, ã‚³ã‚¤ãƒ³ç”Ÿæˆ`);
        
        // ã‚³ã‚¤ãƒ³ã‚’æ•µã®ä½ç½®ã«ç”Ÿæˆ
        const pos = {
          x: prevEnemy.x,
          y: prevEnemy.y
        };
        
        if (pos.x && pos.y) {
          createCoinAt(pos.x, pos.y);
        }
        
        // Mapã‹ã‚‰ã‚‚æ•µè¦ç´ ã‚’å‰Šé™¤
        if (prevEnemy.element && prevEnemy.element.id) {
          enemyElementMap.delete(prevEnemy.element.id);
        }
      }
    });
    
    // æ®‹ç•™è¦ç´ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
    function cleanupRemainingElements() {
      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ã«ãªã‚‹è¦ç´ ã¨ãã®è¦ªè¦ç´ ã®ä¸€è¦§
      const cleanupTargets = [];
    
      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ–­ç‰‡ãŒæ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèª
      document.querySelectorAll('.character').forEach(element => {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ãªãã€Mapã«ãªãHPã‚²ãƒ¼ã‚¸ãŒã‚ã‚‹è¦ç´ ï¼ˆæ•µã®æ®‹éª¸ï¼‰
        if (element.textContent !== 'ğŸ§™' && // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ãªã„
            element.textContent !== 'ğŸª™' && // ã‚³ã‚¤ãƒ³ã§ãªã„
            element.textContent !== 'ğŸªœ' && // éšæ®µã§ãªã„
                element.textContent !== 'ğŸšª' &&
            !stageManager.enemies.some(e => e.element === element)) { // ç¾åœ¨ã®æ•µãƒªã‚¹ãƒˆã«ãªã„
          
          // ç«çƒ(ğŸ”¥)ã¾ãŸã¯æ–(ğŸª„)ã®å ´åˆã€ã‚¿ã‚°ä»˜ã‘ã—ã¦å¾Œã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          if (element.textContent === 'ğŸ”¥' || element.textContent === 'ğŸª„') {
            /*
            if (!element.dataset.markedForRemoval) {
              //console.log(`[Game] æ®‹ç•™æ•µè¦ç´ ã‚’æ¤œå‡º: ${element.textContent}ã€å‰Šé™¤ã—ã¾ã™`);
              element.dataset.markedForRemoval = 'true';
              element.dataset.removalTime = Date.now().toString();
              cleanupTargets.push(element);
            } else {
              // æ—¢ã«ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ã‚‹è¦ç´ ã§ã€5ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆã¯å¼·åˆ¶å‰Šé™¤
              const markedTime = parseInt(element.dataset.removalTime || '0');
              if (Date.now() - markedTime > 5000) {
                console.log(`[Game] é•·æ™‚é–“æ®‹ç•™ã—ã¦ã„ã‚‹è¦ç´ ã‚’å¼·åˆ¶å‰Šé™¤: ${element.textContent}`);
                cleanupTargets.push(element);
              }
            }*/
          } else {
            // ãã®ä»–ã®ä¸æ˜è¦ç´ ã¯ç›´ã¡ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ã«
            console.log(`[Game] ä¸æ˜ãªæ®‹ç•™è¦ç´ ã‚’æ¤œå‡º: ${element.textContent}ã€å‰Šé™¤ã—ã¾ã™`);
            cleanupTargets.push(element);
          }
        }
      });
      
      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ã®è¦ç´ ã‚’å‰Šé™¤
      cleanupTargets.forEach(element => {
        try {
          // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆè¡¨ç¤ºã—ã¦å‰Šé™¤
          element.style.transition = 'opacity 0.3s ease';
          element.style.opacity = '0';
          
          setTimeout(() => {
            try {
              if (element && element.parentNode) {
                element.parentNode.removeChild(element);
              }
            } catch (err) {
              console.warn(`[Game] è¦ç´ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, err);
            }
          }, 300);
        } catch (err) {
          console.warn(`[Game] è¦ç´ ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, err);
          // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã¯ç›´æ¥å‰Šé™¤ã‚’è©¦ã¿ã‚‹
          if (element && element.parentNode) {
            try {
              element.parentNode.removeChild(element);
            } catch (removeErr) {
              console.error(`[Game] è¦ç´ ã®ç›´æ¥å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:`, removeErr);
            }
          }
        }
      });
    }
          
          // 30ç§’ã”ã¨ã«ç‰¹ã«æ–è¦ç´ ã®å¥å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
          setInterval(() => {
      // player-staffã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯ (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ‰€æœ‰ã™ã‚‹æ­£ã—ã„æ–è¦ç´ ã‚’ç‰¹å®š)
      let validStaffElement = null;
      if (wizard && wizard.staffElement && document.body.contains(wizard.staffElement)) {
        validStaffElement = wizard.staffElement;
      }
      
      // ã™ã¹ã¦ã®æ–è¦ç´ ã‚’å–å¾—
      const staffElements = document.querySelectorAll('.character');
      staffElements.forEach(element => {
        if (element.textContent === 'ğŸª„') {
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ­£ã—ã„æ–ã§ãªã„å ´åˆã¯å‰Šé™¤
          if (element !== validStaffElement) {
            console.log('[Game] ç„¡åŠ¹ãªæ–è¦ç´ ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚å‰Šé™¤ã—ã¾ã™ã€‚');
            try {
              if (element.parentNode) {
                element.parentNode.removeChild(element);
              }
            } catch (err) {
              console.warn('[Game] ç„¡åŠ¹ãªæ–è¦ç´ ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', err);
            }
          }
        }
      });
      
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ–ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å†ä½œæˆã‚’è©¦ã¿ã‚‹
      if (wizard && (!wizard.staffElement || !document.body.contains(wizard.staffElement))) {
        console.log('[Game] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†ä½œæˆã‚’ä¿ƒã—ã¾ã™ã€‚');
        if (typeof wizard.createStaffElement === 'function') {
          wizard.createStaffElement();
          wizard.updateStaffPosition();
        }
      }
          }, 30000);
    
    // å®šæœŸçš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œï¼ˆ1ç§’ã”ã¨ï¼‰
    setInterval(cleanupRemainingElements, 1000);
    
    // é€šå¸¸ã®ã‚²ãƒ¼ãƒ æ›´æ–°æ™‚ã«ã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
    cleanupRemainingElements();
    
    // ç¾åœ¨ã®æ•µãƒªã‚¹ãƒˆã‚’æ›´æ–°
    previousLivingEnemies = [...currentEnemies];

    // æ•µãŒæ®‹ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã§éšæ®µã®çŠ¶æ…‹ã‚’æ›´æ–°
    const cleared = stageManager.areAllEnemiesDefeated();
    stair.setActive(cleared);
    
    // éšæ®µã®æ›´æ–°ã¨æ¥è§¦åˆ¤å®š
    stair.update();
    if (stair.checkCollision(wizard)) {
      if (stair.onTouch(wizard)) {
        // ã‚·ãƒ§ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹
        shop.show();
      }
    }

    // ã‚³ã‚¤ãƒ³ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¥è§¦åˆ¤å®š
    const coinElements = document.querySelectorAll('.character');
    coinElements.forEach(element => {
      if (element.textContent === 'ğŸª™') {
        // å„ã‚³ã‚¤ãƒ³ã«å¯¾ã™ã‚‹å‚ç…§ã‚’æŒã¤å¿…è¦ãŒã‚ã‚‹ãŒã€
        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ä½ç½®ã‹ã‚‰åˆ¤å®š
        const rect = element.getBoundingClientRect();
        const coinX = rect.left + rect.width / 2;
        const coinY = rect.top + rect.height / 2;
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®
        const playerRect = wizard.element.getBoundingClientRect();
        const playerX = playerRect.left + playerRect.width / 2;
        const playerY = playerRect.top + playerRect.height / 2;
        
        // è·é›¢ã‚’è¨ˆç®—
        const dx = coinX - playerX;
        const dy = coinY - playerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // 40pxä»¥å†…ã«è¿‘ã¥ã„ãŸã‚‰ã‚³ã‚¤ãƒ³ã‚’å–å¾—
        if (distance < 40) {
          // ã‚³ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          element.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
          element.style.transform = 'scale(1.5)';
          element.style.opacity = '0';
          
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚³ã‚¤ãƒ³ã‚’å¢—ã‚„ã™
          wizard.playerstatus.addCoins(1);
          
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«è¦ç´ ã‚’å‰Šé™¤
          setTimeout(() => {
            if (element && element.parentNode) {
              element.parentNode.removeChild(element);
            }
          }, 300);
        }
      }
    });

    // HUDã‚’æ›´æ–°ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¸¡ã™ï¼‰
    hud.update(wizard.playerstatus);

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°ã™ã‚‹
    if (statusUI.isVisible) {
      statusUI.updateStatusDisplay();
    }
    
    // ãƒ‡ãƒãƒƒã‚°ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°ã™ã‚‹
    if (debugUI.isVisible) {
      debugUI.update();
    }
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒã¨æ•µã®è¡çªåˆ¤å®š
    const enemyTargets = stageManager.enemies;
    
    // æ”»æ’ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ã¨éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ”»æ’ƒã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (wizard.attacks && Array.isArray(wizard.attacks)) {
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ”»æ’ƒã ã‘ã‚’æ®‹ã™
      wizard.attacks = wizard.attacks.filter((fireBall) => {
        // nullãƒã‚§ãƒƒã‚¯
        if (!fireBall) return false;
        
        try {
          // æ”»æ’ƒã®æ›´æ–°
          fireBall.update(enemyTargets);
          
          // æ”»æ’ƒãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ç¢ºèªï¼ˆactiveå±æ€§ãŒãªã„å ´åˆã¯trueã¨ã¿ãªã™ï¼‰
          return fireBall.active !== false;
        } catch (err) {
          console.warn('[Game] æ”»æ’ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', err);
          return false; // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å‰Šé™¤
        }
      });
    }
    
    // æ•µã®æ”»æ’ƒã‚‚åŒæ§˜ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    stageManager.enemies.forEach(enemy => {
      if (enemy.attacks && Array.isArray(enemy.attacks)) {
        enemy.attacks = enemy.attacks.filter(fireBall => {
          if (!fireBall) return false;
          
          try {
            // æ”»æ’ƒãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ç¢ºèª
            return fireBall.active !== false;
          } catch (err) {
            console.warn('[Game] æ•µã®æ”»æ’ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', err);
            return false;
          }
        });
      }
    });
    
    // æ•µã®æ”»æ’ƒã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡çªåˆ¤å®šï¼ˆæ•µã®å†…éƒ¨ã§å‡¦ç†ï¼‰
    // ã™ã§ã«å„æ•µã®updateãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€enemyTargetï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã‚’å¯¾è±¡ã¨ã—ãŸè¡çªåˆ¤å®šãŒè¡Œã‚ã‚Œã¦ã„ã‚‹
    
    // HPãŒ0ã«ãªã£ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
    if (wizard.status.hp <= 0) {
      // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ã‚’è¿½åŠ 
      displayGameOver();
    }
  }

  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤ºé–¢æ•°
  function displayGameOver() {
    // ã™ã§ã«ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ãŒã‚ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (document.getElementById('game-over')) return;
    
    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¦ç´ ã‚’ä½œæˆ
    const gameOverElement = document.createElement('div');
    gameOverElement.id = 'game-over';
    gameOverElement.style.position = 'absolute';
    gameOverElement.style.top = '50%';
    gameOverElement.style.left = '50%';
    gameOverElement.style.transform = 'translate(-50%, -50%)';
    gameOverElement.style.fontSize = '60px';
    gameOverElement.style.fontWeight = 'bold';
    gameOverElement.style.color = 'red';
    gameOverElement.style.textShadow = '3px 3px 5px rgba(0, 0, 0, 0.8)';
    gameOverElement.style.zIndex = '1000';
    gameOverElement.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    gameOverElement.style.padding = '30px';
    gameOverElement.style.borderRadius = '15px';
    gameOverElement.style.textAlign = 'center';
    gameOverElement.innerHTML = `
      <div>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</div>
      <div style="font-size: 30px; margin-top: 20px;">ã‚¹ãƒ†ãƒ¼ã‚¸: ${wizard.playerstatus.stage}</div>
      <div style="font-size: 30px;">ã‚³ã‚¤ãƒ³: ${wizard.playerstatus.coins}</div>
      <div style="font-size: 24px; margin-top: 40px;">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ã«ã¯F5ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    `;
    
    gameArea.appendChild(gameOverElement);
    
    // ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹åŠ¹æœï¼ˆã™ã¹ã¦ã®æ•µã‚’æ­¢ã‚ã‚‹ï¼‰
    stageManager.clearEnemies();
  }
  
  // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹
  requestAnimationFrame(gameLoop);
</script>
</body>
</html>